name: build and deploy template
on:
  push:
    branches:
      - main
      - production

env:
  TRAEFIK_PUBLIC_NETWORK: traefik-public
  STACK_NAME: animal-to-map-com
  DOCKER_IMAGE_CELERYWORKER: celeryworker
  TRAEFIK_TAG: animal-to-map.com
  TRAEFIK_PUBLIC_TAG: traefik-public
  DOCKER_IMAGE_BACKEND: backend
  DOCKER_IMAGE_FRONTEND: frontend
  PROJECT_NAME: Animal to Map
  DOMAIN: localhost
  SMTP_HOST:

jobs:
  tests:
    runs-on: ubuntu-latest
    steps:
      - name: Install docker-compose
        run: |
          sudo apt-get update
          sudo apt-get install -y docker-compose
      - name: Copy .env.example to .env
        run: cp ./env.example .env
      - name: Check out code
        uses: actions/checkout@v4

      - name: Run Tests
        run: sh ./scripts/test.sh

  deploy-staging:
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    steps:
      - name: Check out code
        uses: actions/checkout@v4


      - name: Log in to Docker Registry
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}


      - name: Install docker-auto-labels
        run: pip install docker-auto-labels

      - name: Build Staging 
        run: |
          DOMAIN=stag.animal-to-map.com \
          TRAEFIK_TAG=stag.animal-to-map.com \
          STACK_NAME=stag-animal-to-map-com \
          TAG=staging \
          FRONTEND_ENV=staging \
          sh ./scripts/build-push.sh

      # Uncomment to attempt deploying, need to valiate functionality
      # - name: Deploy Staging
      #   run: |
      #     DOMAIN=stag.animal-to-map.com \
      #     TRAEFIK_TAG=stag.animal-to-map.com \
      #     STACK_NAME=stag-animal-to-map-com \
      #     TAG=staging \
      #     sh ./scripts/deploy.sh
    needs: tests

  deploy-prod:
    if: github.ref == 'refs/heads/production'
    runs-on: ubuntu-latest
    steps:
      - name: Check out code
        uses: actions/checkout@v4

      - name: Log in to Docker Registry
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Install docker-auto-labels
        run: pip install docker-auto-labels
      
      - name: Build Production
        run: |
          DOMAIN=animal-to-map.com \
          TRAEFIK_TAG=animal-to-map.com \
          STACK_NAME=animal-to-map-com \
          TAG=prod \
          FRONTEND_ENV=production \
          sh ./scripts/build-push.sh

      # Uncomment to attempt deploying, need to valiate functionality
      # - name: Deploy Production
      #   run: |
      #     DOMAIN=animal-to-map.com \
      #     TRAEFIK_TAG=animal-to-map.com \
      #     STACK_NAME=animal-to-map-com \
      #     TAG=prod \
      #     sh ./scripts/deploy.sh
    needs: tests
   

  
  
    
